\hypertarget{test-6_2include_2okapi_2api_2control_2async_2async_wrapper_8hpp_source}{}\doxysection{async\+Wrapper.\+hpp}
\label{test-6_2include_2okapi_2api_2control_2async_2async_wrapper_8hpp_source}\index{Pros/test-\/6/include/okapi/api/control/async/asyncWrapper.hpp@{Pros/test-\/6/include/okapi/api/control/async/asyncWrapper.hpp}}

\begin{DoxyCode}{0}
\DoxyCodeLine{1 \textcolor{comment}{/*}}
\DoxyCodeLine{2 \textcolor{comment}{ * This Source Code Form is subject to the terms of the Mozilla Public}}
\DoxyCodeLine{3 \textcolor{comment}{ * License, v. 2.0. If a copy of the MPL was not distributed with this}}
\DoxyCodeLine{4 \textcolor{comment}{ * file, You can obtain one at http://mozilla.org/MPL/2.0/.}}
\DoxyCodeLine{5 \textcolor{comment}{ */}}
\DoxyCodeLine{6 \textcolor{preprocessor}{\#pragma once}}
\DoxyCodeLine{7 }
\DoxyCodeLine{8 \textcolor{preprocessor}{\#include "{}okapi/api/control/async/asyncController.hpp"{}}}
\DoxyCodeLine{9 \textcolor{preprocessor}{\#include "{}okapi/api/control/controllerInput.hpp"{}}}
\DoxyCodeLine{10 \textcolor{preprocessor}{\#include "{}okapi/api/control/iterative/iterativeController.hpp"{}}}
\DoxyCodeLine{11 \textcolor{preprocessor}{\#include "{}okapi/api/control/util/settledUtil.hpp"{}}}
\DoxyCodeLine{12 \textcolor{preprocessor}{\#include "{}okapi/api/coreProsAPI.hpp"{}}}
\DoxyCodeLine{13 \textcolor{preprocessor}{\#include "{}okapi/api/util/abstractRate.hpp"{}}}
\DoxyCodeLine{14 \textcolor{preprocessor}{\#include "{}okapi/api/util/logging.hpp"{}}}
\DoxyCodeLine{15 \textcolor{preprocessor}{\#include "{}okapi/api/util/mathUtil.hpp"{}}}
\DoxyCodeLine{16 \textcolor{preprocessor}{\#include "{}okapi/api/util/supplier.hpp"{}}}
\DoxyCodeLine{17 \textcolor{preprocessor}{\#include <atomic>}}
\DoxyCodeLine{18 \textcolor{preprocessor}{\#include <memory>}}
\DoxyCodeLine{19 }
\DoxyCodeLine{20 \textcolor{keyword}{namespace }okapi \{}
\DoxyCodeLine{21 \textcolor{keyword}{template} <\textcolor{keyword}{typename} Input, \textcolor{keyword}{typename} Output>}
\DoxyCodeLine{22 \textcolor{keyword}{class }AsyncWrapper : \textcolor{keyword}{virtual} \textcolor{keyword}{public} AsyncController<Input, Output> \{}
\DoxyCodeLine{23   \textcolor{keyword}{public}:}
\DoxyCodeLine{35   \mbox{\hyperlink{classokapi_1_1_async_wrapper_ad5c4f7f5cb696854d97b915086f53db5}{AsyncWrapper}}(\textcolor{keyword}{const} std::shared\_ptr<\mbox{\hyperlink{classokapi_1_1_controller_input}{ControllerInput<Input>}}> \&iinput,}
\DoxyCodeLine{36                \textcolor{keyword}{const} std::shared\_ptr<\mbox{\hyperlink{classokapi_1_1_controller_output}{ControllerOutput<Output>}}> \&ioutput,}
\DoxyCodeLine{37                \textcolor{keyword}{const} std::shared\_ptr<\mbox{\hyperlink{classokapi_1_1_iterative_controller}{IterativeController<Input, Output>}}> \&icontroller,}
\DoxyCodeLine{38                \textcolor{keyword}{const} \mbox{\hyperlink{classokapi_1_1_supplier}{Supplier}}<std::unique\_ptr<AbstractRate>> \&irateSupplier,}
\DoxyCodeLine{39                \textcolor{keyword}{const} \textcolor{keywordtype}{double} iratio = 1,}
\DoxyCodeLine{40                std::shared\_ptr<Logger> ilogger = \mbox{\hyperlink{classokapi_1_1_logger_ac9dd2e38a412a692816f150b0ac3f0b4}{Logger::getDefaultLogger}}())}
\DoxyCodeLine{41     : logger(std::move(ilogger)),}
\DoxyCodeLine{42       rateSupplier(irateSupplier),}
\DoxyCodeLine{43       input(iinput),}
\DoxyCodeLine{44       output(ioutput),}
\DoxyCodeLine{45       controller(icontroller),}
\DoxyCodeLine{46       ratio(iratio) \{}
\DoxyCodeLine{47   \}}
\DoxyCodeLine{48 }
\DoxyCodeLine{49   \mbox{\hyperlink{classokapi_1_1_async_wrapper}{AsyncWrapper}}(\mbox{\hyperlink{classokapi_1_1_async_wrapper}{AsyncWrapper<Input, Output>}} \&\&other) = \textcolor{keyword}{delete};}
\DoxyCodeLine{50 }
\DoxyCodeLine{51   \mbox{\hyperlink{classokapi_1_1_async_wrapper}{AsyncWrapper<Input, Output>}} \&operator=(\mbox{\hyperlink{classokapi_1_1_async_wrapper}{AsyncWrapper<Input, Output>}} \&\&other) = \textcolor{keyword}{delete};}
\DoxyCodeLine{52 }
\DoxyCodeLine{53   \mbox{\hyperlink{classokapi_1_1_async_wrapper}{\string~AsyncWrapper}}()\textcolor{keyword}{ override }\{}
\DoxyCodeLine{54     dtorCalled.store(\textcolor{keyword}{true}, std::memory\_order\_release);}
\DoxyCodeLine{55     \textcolor{keyword}{delete} task;}
\DoxyCodeLine{56   \}}
\DoxyCodeLine{57 }
\DoxyCodeLine{61   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_aa4b9a4ff29aff5047425e239b574c3c6}{setTarget}}(\textcolor{keyword}{const} Input itarget)\textcolor{keyword}{ override }\{}
\DoxyCodeLine{62     LOG\_INFO(\textcolor{stringliteral}{"{}AsyncWrapper: Set target to "{}} + std::to\_string(itarget));}
\DoxyCodeLine{63     hasFirstTarget = \textcolor{keyword}{true};}
\DoxyCodeLine{64     controller-\/>setTarget(itarget * ratio);}
\DoxyCodeLine{65     lastTarget = itarget;}
\DoxyCodeLine{66   \}}
\DoxyCodeLine{67 }
\DoxyCodeLine{74   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_aec6d1a4214bad2151bee23dc5e8076e7}{controllerSet}}(\textcolor{keyword}{const} Input ivalue)\textcolor{keyword}{ override }\{}
\DoxyCodeLine{75     controller-\/>controllerSet(ivalue);}
\DoxyCodeLine{76   \}}
\DoxyCodeLine{77 }
\DoxyCodeLine{83   Input \mbox{\hyperlink{classokapi_1_1_async_wrapper_a2471c7b5f388d441db77fa9199db7b83}{getTarget}}()\textcolor{keyword}{ override }\{}
\DoxyCodeLine{84     \textcolor{keywordflow}{return} controller-\/>getTarget();}
\DoxyCodeLine{85   \}}
\DoxyCodeLine{86 }
\DoxyCodeLine{90   Input \mbox{\hyperlink{classokapi_1_1_async_wrapper_ad1c7a4258eb5ad5127fe12d7b78ddb15}{getProcessValue}}()\textcolor{keyword}{ const override }\{}
\DoxyCodeLine{91     \textcolor{keywordflow}{return} controller-\/>getProcessValue();}
\DoxyCodeLine{92   \}}
\DoxyCodeLine{93 }
\DoxyCodeLine{97   Output \mbox{\hyperlink{classokapi_1_1_async_wrapper_a6f3859f212f0348e73df98c83208f3c4}{getOutput}}()\textcolor{keyword}{ const }\{}
\DoxyCodeLine{98     \textcolor{keywordflow}{return} controller-\/>getOutput();}
\DoxyCodeLine{99   \}}
\DoxyCodeLine{100 }
\DoxyCodeLine{104   Output \mbox{\hyperlink{classokapi_1_1_async_wrapper_a64b690883ff7475375a6d08ad3fb62f9}{getError}}()\textcolor{keyword}{ const override }\{}
\DoxyCodeLine{105     \textcolor{keywordflow}{return} controller-\/>getError();}
\DoxyCodeLine{106   \}}
\DoxyCodeLine{107 }
\DoxyCodeLine{116   \textcolor{keywordtype}{bool} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a93343937a8bbe762aeb6460197a22dfe}{isSettled}}()\textcolor{keyword}{ override }\{}
\DoxyCodeLine{117     \textcolor{keywordflow}{return} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a83d411851373f0483b5ae392560a180a}{isDisabled}}() || controller-\/>isSettled();}
\DoxyCodeLine{118   \}}
\DoxyCodeLine{119 }
\DoxyCodeLine{125   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_afe14fb6e7727c313bd40cf74d28f0a14}{setSampleTime}}(\textcolor{keyword}{const} QTime \&isampleTime) \{}
\DoxyCodeLine{126     controller-\/>setSampleTime(isampleTime);}
\DoxyCodeLine{127   \}}
\DoxyCodeLine{128 }
\DoxyCodeLine{135   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a668c83b4a2b5bee7f2d072b57157d19a}{setOutputLimits}}(\textcolor{keyword}{const} Output imax, \textcolor{keyword}{const} Output imin) \{}
\DoxyCodeLine{136     controller-\/>setOutputLimits(imax, imin);}
\DoxyCodeLine{137   \}}
\DoxyCodeLine{138 }
\DoxyCodeLine{146   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a9cb3a50a27e7d3e1263ed3aa6c57bb82}{setControllerSetTargetLimits}}(\textcolor{keywordtype}{double} itargetMax, \textcolor{keywordtype}{double} itargetMin) \{}
\DoxyCodeLine{147     controller-\/>setControllerSetTargetLimits(itargetMax, itargetMin);}
\DoxyCodeLine{148   \}}
\DoxyCodeLine{149 }
\DoxyCodeLine{155   Output \mbox{\hyperlink{classokapi_1_1_async_wrapper_a95112bac1792ef04010cd97efa135998}{getMaxOutput}}() \{}
\DoxyCodeLine{156     \textcolor{keywordflow}{return} controller-\/>getMaxOutput();}
\DoxyCodeLine{157   \}}
\DoxyCodeLine{158 }
\DoxyCodeLine{164   Output \mbox{\hyperlink{classokapi_1_1_async_wrapper_a41ccefbf1da06cca1ec525d0ad80fa00}{getMinOutput}}() \{}
\DoxyCodeLine{165     \textcolor{keywordflow}{return} controller-\/>getMinOutput();}
\DoxyCodeLine{166   \}}
\DoxyCodeLine{167 }
\DoxyCodeLine{172   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a9372a74580e5be429ecd65ec0e110c23}{reset}}()\textcolor{keyword}{ override }\{}
\DoxyCodeLine{173     LOG\_INFO\_S(\textcolor{stringliteral}{"{}AsyncWrapper: Reset"{}});}
\DoxyCodeLine{174     controller-\/>reset();}
\DoxyCodeLine{175     hasFirstTarget = \textcolor{keyword}{false};}
\DoxyCodeLine{176   \}}
\DoxyCodeLine{177 }
\DoxyCodeLine{182   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_afdf4d80b0f3eec3d77280a561b24f0b0}{flipDisable}}()\textcolor{keyword}{ override }\{}
\DoxyCodeLine{183     LOG\_INFO(\textcolor{stringliteral}{"{}AsyncWrapper: flipDisable "{}} + std::to\_string(!controller-\/>isDisabled()));}
\DoxyCodeLine{184     controller-\/>flipDisable();}
\DoxyCodeLine{185     \mbox{\hyperlink{classokapi_1_1_async_wrapper_a67fa1bf10df9b8f3c280d8f2b136038a}{resumeMovement}}();}
\DoxyCodeLine{186   \}}
\DoxyCodeLine{187 }
\DoxyCodeLine{194   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_ab47f9a7ee52a5d699cb39b21b0926981}{flipDisable}}(\textcolor{keyword}{const} \textcolor{keywordtype}{bool} iisDisabled)\textcolor{keyword}{ override }\{}
\DoxyCodeLine{195     LOG\_INFO(\textcolor{stringliteral}{"{}AsyncWrapper: flipDisable "{}} + std::to\_string(iisDisabled));}
\DoxyCodeLine{196     controller-\/>flipDisable(iisDisabled);}
\DoxyCodeLine{197     \mbox{\hyperlink{classokapi_1_1_async_wrapper_a67fa1bf10df9b8f3c280d8f2b136038a}{resumeMovement}}();}
\DoxyCodeLine{198   \}}
\DoxyCodeLine{199 }
\DoxyCodeLine{205   \textcolor{keywordtype}{bool} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a83d411851373f0483b5ae392560a180a}{isDisabled}}()\textcolor{keyword}{ const override }\{}
\DoxyCodeLine{206     \textcolor{keywordflow}{return} controller-\/>isDisabled();}
\DoxyCodeLine{207   \}}
\DoxyCodeLine{208 }
\DoxyCodeLine{213   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a23435c257ac2d6df59ab5d96408e608a}{waitUntilSettled}}()\textcolor{keyword}{ override }\{}
\DoxyCodeLine{214     LOG\_INFO\_S(\textcolor{stringliteral}{"{}AsyncWrapper: Waiting to settle"{}});}
\DoxyCodeLine{215 }
\DoxyCodeLine{216     \textcolor{keyword}{auto} rate = rateSupplier.get();}
\DoxyCodeLine{217     \textcolor{keywordflow}{while} (!\mbox{\hyperlink{classokapi_1_1_async_wrapper_a93343937a8bbe762aeb6460197a22dfe}{isSettled}}()) \{}
\DoxyCodeLine{218       rate-\/>delayUntil(motorUpdateRate);}
\DoxyCodeLine{219     \}}
\DoxyCodeLine{220 }
\DoxyCodeLine{221     LOG\_INFO\_S(\textcolor{stringliteral}{"{}AsyncWrapper: Done waiting to settle"{}});}
\DoxyCodeLine{222   \}}
\DoxyCodeLine{223 }
\DoxyCodeLine{228   \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a5225a6b4748da30bf17ddbda692cbf4a}{startThread}}() \{}
\DoxyCodeLine{229     \textcolor{keywordflow}{if} (!task) \{}
\DoxyCodeLine{230       task = \textcolor{keyword}{new} \mbox{\hyperlink{class_crossplatform_thread}{CrossplatformThread}}(trampoline, \textcolor{keyword}{this}, \textcolor{stringliteral}{"{}AsyncWrapper"{}});}
\DoxyCodeLine{231     \}}
\DoxyCodeLine{232   \}}
\DoxyCodeLine{233 }
\DoxyCodeLine{239   \mbox{\hyperlink{class_crossplatform_thread}{CrossplatformThread}} *\mbox{\hyperlink{classokapi_1_1_async_wrapper_a41b7503e92a977d8daaf4c191e9aec77}{getThread}}()\textcolor{keyword}{ const }\{}
\DoxyCodeLine{240     \textcolor{keywordflow}{return} task;}
\DoxyCodeLine{241   \}}
\DoxyCodeLine{242 }
\DoxyCodeLine{243   \textcolor{keyword}{protected}:}
\DoxyCodeLine{244   std::shared\_ptr<Logger> logger;}
\DoxyCodeLine{245   \mbox{\hyperlink{classokapi_1_1_supplier}{Supplier<std::unique\_ptr<AbstractRate>}}> rateSupplier;}
\DoxyCodeLine{246   std::shared\_ptr<ControllerInput<Input>> input;}
\DoxyCodeLine{247   std::shared\_ptr<ControllerOutput<Output>> output;}
\DoxyCodeLine{248   std::shared\_ptr<IterativeController<Input, Output>> controller;}
\DoxyCodeLine{249   \textcolor{keywordtype}{bool} hasFirstTarget\{\textcolor{keyword}{false}\};}
\DoxyCodeLine{250   Input lastTarget;}
\DoxyCodeLine{251   \textcolor{keywordtype}{double} ratio;}
\DoxyCodeLine{252   std::atomic\_bool dtorCalled\{\textcolor{keyword}{false}\};}
\DoxyCodeLine{253   \mbox{\hyperlink{class_crossplatform_thread}{CrossplatformThread}} *task\{\textcolor{keyword}{nullptr}\};}
\DoxyCodeLine{254 }
\DoxyCodeLine{255   \textcolor{keyword}{static} \textcolor{keywordtype}{void} trampoline(\textcolor{keywordtype}{void} *context) \{}
\DoxyCodeLine{256     \textcolor{keywordflow}{if} (context) \{}
\DoxyCodeLine{257       \textcolor{keyword}{static\_cast<}\mbox{\hyperlink{classokapi_1_1_async_wrapper_ad5c4f7f5cb696854d97b915086f53db5}{AsyncWrapper}} *\textcolor{keyword}{>}(context)-\/>loop();}
\DoxyCodeLine{258     \}}
\DoxyCodeLine{259   \}}
\DoxyCodeLine{260 }
\DoxyCodeLine{261   \textcolor{keywordtype}{void} loop() \{}
\DoxyCodeLine{262     \textcolor{keyword}{auto} rate = rateSupplier.\mbox{\hyperlink{classokapi_1_1_supplier_a38d76d4c3dcc19fd74f5349660199efe}{get}}();}
\DoxyCodeLine{263     \textcolor{keywordflow}{while} (!dtorCalled.load(std::memory\_order\_acquire) \&\& !task-\/>notifyTake(0)) \{}
\DoxyCodeLine{264       \textcolor{keywordflow}{if} (!\mbox{\hyperlink{classokapi_1_1_async_wrapper_a83d411851373f0483b5ae392560a180a}{isDisabled}}()) \{}
\DoxyCodeLine{265         output-\/>controllerSet(controller-\/>step(input-\/>controllerGet()));}
\DoxyCodeLine{266       \}}
\DoxyCodeLine{267 }
\DoxyCodeLine{268       rate-\/>delayUntil(controller-\/>getSampleTime());}
\DoxyCodeLine{269     \}}
\DoxyCodeLine{270   \}}
\DoxyCodeLine{271 }
\DoxyCodeLine{276   \textcolor{keyword}{virtual} \textcolor{keywordtype}{void} \mbox{\hyperlink{classokapi_1_1_async_wrapper_a67fa1bf10df9b8f3c280d8f2b136038a}{resumeMovement}}() \{}
\DoxyCodeLine{277     \textcolor{keywordflow}{if} (\mbox{\hyperlink{classokapi_1_1_async_wrapper_a83d411851373f0483b5ae392560a180a}{isDisabled}}()) \{}
\DoxyCodeLine{278       \textcolor{comment}{// This will grab the output *when disabled*}}
\DoxyCodeLine{279       output-\/>controllerSet(controller-\/>getOutput());}
\DoxyCodeLine{280     \} \textcolor{keywordflow}{else} \{}
\DoxyCodeLine{281       \textcolor{keywordflow}{if} (hasFirstTarget) \{}
\DoxyCodeLine{282         \mbox{\hyperlink{classokapi_1_1_async_wrapper_aa4b9a4ff29aff5047425e239b574c3c6}{setTarget}}(lastTarget);}
\DoxyCodeLine{283       \}}
\DoxyCodeLine{284     \}}
\DoxyCodeLine{285   \}}
\DoxyCodeLine{286 \};}
\DoxyCodeLine{287 \} \textcolor{comment}{// namespace okapi}}

\end{DoxyCode}
